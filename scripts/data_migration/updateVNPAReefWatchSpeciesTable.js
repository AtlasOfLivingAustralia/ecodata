/*
 * Copyright (C) 2021 Atlas of Living Australia
 * All Rights Reserved.
 *
 * The contents of this file are subject to the Mozilla Public
 * License Version 1.1 (the "License"); you may not use this file
 * except in compliance with the License. You may obtain a copy of
 * the License at http://www.mozilla.org/MPL/
 *
 * Software distributed under the License is distributed on an "AS
 * IS" basis, WITHOUT WARRANTY OF ANY KIND, either express or
 * implied. See the License for the specific language governing
 * rights and limitations under the License.
 * 
 * Created by Temi on 17/11/21.
 */
var speciesList = [
    {
        "commonName": {
            "commonName": "Dusky Morwong",
            "scientificName": "Dactylophora nigricans",
            "name": "Dusky Morwong (Dactylophora nigricans)",
            "guid": "urn:lsid:biodiversity.org.au:afd.taxon:5618cb8d-a4ca-4bb5-bbbc-cc4d3eaacc04"
        },
        "abundanceClass": "",
        "scientificName": "Dactylophora nigricans",
        "individualCount": "",
        "dataType": "species",
        "dwcAttribute": "scientificName",
        "speciesImage": ""
    },
    {
        "commonName": {
            "commonName": "Red Morwong",
            "scientificName": "Cheilodactylus fuscus",
            "name": "Red Morwong (Cheilodactylus fuscus)",
            "guid": "urn:lsid:biodiversity.org.au:afd.taxon:73df0898-150d-464b-8748-6383268fbb5e"
        },
        "abundanceClass": "",
        "scientificName": "Cheilodactylus fuscus",
        "dataType": "species",
        "dwcAttribute": "scientificName",
        "speciesImage": ""
    },
    {
        "commonName": {
            "commonName": "Banded Morwong",
            "scientificName": "Cheilodactylus spectabilis",
            "name": "Banded Morwong (Cheilodactylus spectabilis)",
            "guid": "urn:lsid:biodiversity.org.au:afd.taxon:339f1b35-3f79-4dfe-a34a-fb7d954b21db"
        },
        "abundanceClass": "",
        "scientificName": "Cheilodactylus spectabilis",
        "dataType": "species",
        "dwcAttribute": "scientificName",
        "speciesImage": ""
    },
    {
        "commonName": {
            "commonName": "Magpie Pearch",
            "scientificName": "Cheilodactylus nigripes",
            "name": "Magpie Pearch (Cheilodactylus nigripes)",
            "guid": "urn:lsid:biodiversity.org.au:afd.taxon:f48ea118-2084-42d8-aa57-fe0b6c64cf9a"
        },
        "abundanceClass": "",
        "scientificName": "Cheilodactylus nigripes",
        "dataType": "species",
        "dwcAttribute": "scientificName",
        "speciesImage": ""
    },
    {
        "commonName": {
            "commonName": "Bastard Trumpeter",
            "scientificName": "Latridopsis forsteri",
            "name": "Bastard Trumpeter (Latridopsis forsteri)",
            "guid": "urn:lsid:biodiversity.org.au:afd.taxon:c8d82497-db2a-475d-abc2-713b690deb11"
        },
        "abundanceClass": "",
        "scientificName": "Latridopsis forsteri",
        "dataType": "species",
        "dwcAttribute": "scientificName",
        "speciesImage": ""
    },
    {
        "commonName": {
            "commonName": "Herring Cale",
            "scientificName": "Odax cyanomelas",
            "name": "Herring Cale (Odax cyanomelas)",
            "guid": "urn:lsid:biodiversity.org.au:afd.taxon:2505fa15-3e40-4615-8504-29e3938d8ac1"
        },
        "abundanceClass": "",
        "scientificName": "Odax cyanomelas",
        "dataType": "species",
        "dwcAttribute": "scientificName",
        "speciesImage": ""
    },
    {
        "commonName": {
            "commonName": "Horseshoe Leatherjacket",
            "scientificName": "Meuschenia hippocrepis",
            "name": "Horseshoe Leatherjacket (Meuschenia hippocrepis)",
            "guid": "urn:lsid:biodiversity.org.au:afd.taxon:33b4eadf-6abf-4e46-a960-2989775e3739"
        },
        "abundanceClass": "",
        "scientificName": "Meuschenia hippocrepis",
        "dataType": "species",
        "dwcAttribute": "scientificName",
        "speciesImage": ""
    },
    {
        "commonName": {
            "commonName": "Six-spined Leatherjacket",
            "scientificName": "Meuschenia freycineti",
            "name": "Six-spined Leatherjacket (Meuschenia freycineti)",
            "guid": "urn:lsid:biodiversity.org.au:afd.taxon:274562d2-a5d6-42bb-a9bd-2f6b586e2c73"
        },
        "abundanceClass": "",
        "scientificName": "Meuschenia freycineti",
        "dataType": "species",
        "dwcAttribute": "scientificName",
        "speciesImage": ""
    },
    {
        "commonName": {
            "commonName": "Zebra Fish",
            "scientificName": "Girella zebra",
            "name": "Zebra Fish (Girella zebra)",
            "guid": "urn:lsid:biodiversity.org.au:afd.taxon:374a7933-97b9-455a-8d9d-c8767d4cb22b"
        },
        "abundanceClass": "",
        "scientificName": "Girella zebra",
        "dataType": "species",
        "dwcAttribute": "scientificName",
        "speciesImage": ""
    },
    {
        "commonName": {
            "commonName": "Southern Blue Devil",
            "scientificName": "Paraplesiops meleagris",
            "name": "Southern Blue Devil (Paraplesiops meleagris)",
            "guid": "urn:lsid:biodiversity.org.au:afd.taxon:bee71788-0df3-472e-a692-07823d70ab99"
        },
        "abundanceClass": "",
        "scientificName": "Paraplesiops meleagris",
        "dataType": "species",
        "dwcAttribute": "scientificName",
        "speciesImage": ""
    },
    {
        "commonName": {
            "commonName": "Ornate Cowfish",
            "scientificName": "Aracana ornata",
            "name": "Ornate Cowfish (Aracana ornata)",
            "guid": "urn:lsid:biodiversity.org.au:afd.taxon:1d01be3f-6889-45ff-9c61-19e09e5f2452"
        },
        "abundanceClass": "",
        "scientificName": "Aracana ornata",
        "dataType": "species",
        "dwcAttribute": "scientificName",
        "speciesImage": ""
    },
    {
        "commonName": {
            "commonName": "Shaw's Cowfish",
            "scientificName": "Aracana aurita",
            "name": "Shaw's Cowfish (Aracana aurita)",
            "guid": "urn:lsid:biodiversity.org.au:afd.taxon:fb435306-1f8a-4eb1-bb0e-d8d45d06c326"
        },
        "abundanceClass": "",
        "scientificName": "Aracana aurita",
        "dataType": "species",
        "dwcAttribute": "scientificName",
        "speciesImage": ""
    },
    {
        "commonName": {
            "commonName": "Victorian Scalyfin",
            "scientificName": "Parma victoriae",
            "name": "Victorian Scalyfin (Parma victoriae)",
            "guid": "urn:lsid:biodiversity.org.au:afd.taxon:f86cc61c-9e0e-4c9d-8e1b-cbfc9538c8f3"
        },
        "image": "speciesImage",
        "abundanceClass": "",
        "scientificName": "Parma victoriae",
        "dataType": "species",
        "dwcAttribute": "scientificName"
    },
    {
        "commonName": {
            "commonName": "Long-snouted Boarfish",
            "scientificName": "Pentaceropsis recurvirostris",
            "name": "Long-snouted Boarfish (Pentaceropsis recurvirostris)",
            "guid": "urn:lsid:biodiversity.org.au:afd.taxon:96d59c8f-eb44-49e5-baa9-9fcd60471772"
        },
        "image": "speciesImage",
        "abundanceClass": "",
        "scientificName": "Pentaceropsis recurvirostris",
        "dataType": "species",
        "dwcAttribute": "scientificName"
    },
    {
        "commonName": {
            "commonName": "Old Wife",
            "scientificName": "Enoplosus armatus",
            "name": "Old Wife (Enoplosus armatus)",
            "guid": "urn:lsid:biodiversity.org.au:afd.taxon:6f1435ae-6fe0-443f-af2a-6fafaf5896b5"
        },
        "image": "speciesImage",
        "abundanceClass": "",
        "scientificName": "Enoplosus armatus",
        "dataType": "species",
        "dwcAttribute": "scientificName"
    },
    {
        "commonName": {
            "commonName": "Sea Sweep",
            "scientificName": "Scorpis aequipinnis",
            "name": "Sea Sweep (Scorpis aequipinnis)",
            "guid": "urn:lsid:biodiversity.org.au:afd.taxon:61843f5b-e039-411f-bedc-33c66bd5cdb2"
        },
        "image": "speciesImage",
        "abundanceClass": "",
        "scientificName": "Scorpis aequipinnis",
        "dataType": "species",
        "dwcAttribute": "scientificName"
    },
    {
        "commonName": {
            "commonName": "Silver Sweep",
            "scientificName": "Scorpis lineolata",
            "name": "Silver Sweep (Scorpis lineolata)",
            "guid": "urn:lsid:biodiversity.org.au:afd.taxon:5fbec2c1-ace3-4c52-8003-036ada5bc4da"
        },
        "image": "speciesImage",
        "abundanceClass": "",
        "scientificName": "Scorpis lineolata",
        "dataType": "species",
        "dwcAttribute": "scientificName"
    },
    {
        "commonName": {
            "commonName": "Western Blue Groper",
            "scientificName": "Achoerodus gouldii",
            "name": "Western Blue Groper (Achoerodus gouldii)",
            "guid": "urn:lsid:biodiversity.org.au:afd.taxon:84f7b43a-46a7-4db3-97b6-ef966dc4f0c4"
        },
        "image": "speciesImage",
        "abundanceClass": "",
        "scientificName": "Achoerodus gouldii",
        "dataType": "species",
        "dwcAttribute": "scientificName"
    },
    {
        "commonName": {
            "commonName": "Eastern Blue Groper",
            "scientificName": "Achoerodus viridis",
            "name": "Eastern Blue Groper (Achoerodus viridis)",
            "guid": "urn:lsid:biodiversity.org.au:afd.taxon:d9b5a99b-768a-4266-9f68-243f24d52ba4"
        },
        "image": "speciesImage",
        "abundanceClass": "",
        "scientificName": "Achoerodus viridis",
        "dataType": "species",
        "dwcAttribute": "scientificName"
    },
    {
        "commonName": {
            "commonName": "Blue Throat Wrasse",
            "scientificName": "Notolabrus tetricus",
            "name": "Blue Throat Wrasse (Notolabrus tetricus)",
            "guid": "urn:lsid:biodiversity.org.au:afd.taxon:ce0c1289-1ba8-4565-8d74-70273db12059"
        },
        "image": "speciesImage",
        "abundanceClass": "",
        "scientificName": "Notolabrus tetricus",
        "dataType": "species",
        "dwcAttribute": "scientificName"
    },
    {
        "commonName": {
            "commonName": "Saddled Wrasse",
            "scientificName": "Notolabrus fucicola",
            "name": "Saddled Wrasse (Notolabrus fucicola)",
            "guid": "urn:lsid:biodiversity.org.au:afd.taxon:320bbe44-e8b3-4a90-abdc-e931910e3297"
        },
        "image": "speciesImage",
        "abundanceClass": "",
        "scientificName": "Notolabrus fucicola",
        "dataType": "species",
        "dwcAttribute": "scientificName"
    },
    {
        "commonName": {
            "commonName": "Senator Wrasse",
            "scientificName": "Pictilabrus laticlavius",
            "name": "Senator Wrasse (Pictilabrus laticlavius)",
            "guid": "urn:lsid:biodiversity.org.au:afd.taxon:306b68db-f145-4729-a0c4-ef60fa96cb6a"
        },
        "image": "speciesImage",
        "abundanceClass": "",
        "scientificName": "Pictilabrus laticlavius",
        "dataType": "species",
        "dwcAttribute": "scientificName"
    },
    {
        "commonName": {
            "commonName": "Maori Wrasse",
            "scientificName": "Ophthalmolepis lineolatus",
            "name": "Maori Wrasse (Ophthalmolepis lineolatus)",
            "guid": "urn:lsid:biodiversity.org.au:afd.taxon:98c8d0dc-64f7-41e7-9559-ff02ef978ab2"
        },
        "abundanceClass": "",
        "scientificName": "Ophthalmolepis lineolatus",
        "dataType": "species",
        "dwcAttribute": "scientificName",
        "speciesImage": ""
    },
    {
        "commonName": {
            "commonName": "Harlequin fish",
            "scientificName": "Othos dentex",
            "name": "Harlequin fish (Othos dentex)",
            "guid": "urn:lsid:biodiversity.org.au:afd.taxon:0827e08a-0a56-4f8d-a345-f049ce6b9fc6"
        },
        "abundanceClass": "",
        "scientificName": "Othos dentex",
        "dataType": "species",
        "dwcAttribute": "scientificName",
        "speciesImage": ""
    },
    {
        "commonName": {
            "commonName": "Weedy Sea Dragon",
            "scientificName": "Phyllopteryx taeniolatus",
            "name": "Weedy Sea Dragon (Phyllopteryx taeniolatus)",
            "guid": "urn:lsid:biodiversity.org.au:afd.taxon:64a63130-12c0-4147-aafa-43f372888f0a"
        },
        "abundanceClass": "",
        "scientificName": "Phyllopteryx taeniolatus",
        "dataType": "species",
        "dwcAttribute": "scientificName",
        "speciesImage": ""
    },
    {
        "commonName": {
            "commonName": "Smooth stingray",
            "scientificName": "Bathytoshia brevicaudata",
            "name": "Smooth stingray (Bathytoshia brevicaudata)",
            "guid": "urn:lsid:biodiversity.org.au:afd.taxon:548b1d97-1dc8-49d6-9fe9-13c7b4a70f40"
        },
        "abundanceClass": "",
        "scientificName": "Bathytoshia brevicaudata",
        "dataType": "species",
        "dwcAttribute": "scientificName",
        "speciesImage": ""
    },
    {
        "commonName": {
            "commonName": "Black stingray",
            "scientificName": "Bathytoshia lata",
            "name": "Black stingray (Bathytoshia lata)",
            "guid": "urn:lsid:biodiversity.org.au:afd.taxon:a5c34ad0-7c59-42b5-95fc-d205f1f7cb91"
        },
        "abundanceClass": "",
        "scientificName": "Bathytoshia lata",
        "dataType": "species",
        "dwcAttribute": "scientificName",
        "speciesImage": ""
    },
    {
        "commonName": {
            "commonName": "Spotted stingaree",
            "scientificName": "Urolophus gigas",
            "name": "Spotted stingaree (Urolophus gigas)",
            "guid": "urn:lsid:biodiversity.org.au:afd.taxon:cefb5c15-684f-4289-9b7d-66d17cdcba3f"
        },
        "abundanceClass": "",
        "scientificName": "Urolophus gigas",
        "dataType": "species",
        "dwcAttribute": "scientificName",
        "speciesImage": ""
    },
    {
        "commonName": {
            "commonName": "Southern Fiddler Ray",
            "scientificName": "Trygonorrhina dumerilii",
            "name": "Southern Fiddler Ray (Trygonorrhina dumerilii)",
            "guid": "urn:lsid:biodiversity.org.au:afd.taxon:179e26a4-32e4-45da-a0df-e7621672b988"
        },
        "abundanceClass": "",
        "scientificName": "Trygonorrhina dumerilii",
        "dataType": "species",
        "dwcAttribute": "scientificName",
        "speciesImage": ""
    },
    {
        "commonName": {
            "commonName": "Southern Eagle Ray",
            "scientificName": "Myliobatis tenuicaudatus",
            "name": "Southern Eagle Ray (Myliobatis tenuicaudatus)",
            "guid": "urn:lsid:biodiversity.org.au:afd.taxon:22772c0f-b270-447c-9063-557e7b411f1e"
        },
        "abundanceClass": "",
        "scientificName": "Myliobatis tenuicaudatus",
        "dataType": "species",
        "dwcAttribute": "scientificName",
        "speciesImage": ""
    },
    {
        "commonName": {
            "commonName": "Port Jackson Shark",
            "scientificName": "Heterodontus portusjacksoni",
            "name": "Port Jackson Shark (Heterodontus portusjacksoni)",
            "guid": "urn:lsid:biodiversity.org.au:afd.taxon:a509b9a5-6190-491f-8a1c-f3b947e1584a"
        },
        "abundanceClass": "",
        "scientificName": "Heterodontus portusjacksoni",
        "dataType": "species",
        "dwcAttribute": "scientificName",
        "speciesImage": ""
    },
    {
        "commonName": {
            "commonName": "Spotted wobbegong",
            "scientificName": "Orectolobus maculatus",
            "name": "Spotted wobbegong (Orectolobus maculatus)",
            "guid": "urn:lsid:biodiversity.org.au:afd.taxon:3a14ae5d-cc78-4790-b4ac-a1fea9e024d8"
        },
        "abundanceClass": "",
        "scientificName": "Orectolobus maculatus",
        "dataType": "species",
        "dwcAttribute": "scientificName",
        "speciesImage": ""
    },
    {
        "commonName": {
            "commonName": "Elephantfish / Australian ghost shark",
            "scientificName": "Callorhinchus milii",
            "name": "Elephantfish / Australian ghost shark (Callorhinchus milii)",
            "guid": "urn:lsid:biodiversity.org.au:afd.taxon:6f166b6d-02e0-4182-9091-eb216826c3eb"
        },
        "abundanceClass": "",
        "scientificName": "Callorhinchus milii",
        "dataType": "species",
        "dwcAttribute": "scientificName",
        "speciesImage": ""
    },
    {
        "commonName": {
            "commonName": "Varied Carpetshark",
            "scientificName": "Parascyllium variolatum",
            "name": "Varied Carpetshark (Parascyllium variolatum)",
            "guid": "urn:lsid:biodiversity.org.au:afd.taxon:1a969fcc-95b7-4c85-a4dd-05dacf6d6b7c"
        },
        "abundanceClass": "",
        "scientificName": "Parascyllium variolatum",
        "dataType": "species",
        "dwcAttribute": "scientificName",
        "speciesImage": ""
    },
    {
        "commonName": {
            "commonName": "Draughtboard / swell shark",
            "scientificName": "Cephaloscyllium laticeps",
            "name": "Draughtboard / swell shark (Cephaloscyllium laticeps)",
            "guid": "urn:lsid:biodiversity.org.au:afd.taxon:7f38f65e-2aa5-4721-8bec-25e043618265"
        },
        "abundanceClass": "",
        "scientificName": "Cephaloscyllium laticeps",
        "dataType": "species",
        "dwcAttribute": "scientificName",
        "speciesImage": ""
    }
];
var listOfActivities = db.runCommand({
    "distinct" :  "activity",
    "key" : "activityId",
    "query" :  {projectId: "99915577-ada2-48ef-907e-193550ac66bb", projectActivityId: "95ae9f55-d4c1-4ebe-a662-02864641ce8a"}
}).values;
// listOfActivities = [listOfActivities[0]]

var countUpdated = 0, errorUpdated =0, totalRecords = listOfActivities.length;
listOfActivities.forEach(function (activityId) {
    // print("Activity ID " + activityId);
    var cursor = db.output.find({activityId: activityId});
    while(cursor.hasNext()){
        var output = cursor.next();
        var taxaObservations = output.data.taxaObservations;
        if (taxaObservations && taxaObservations.length) {
            var updated = false;
            taxaObservations.forEach(function (row, index) {
                var commonUpdated;
                if(typeof row.commonName === "string") {
                    if (speciesList[index].commonName.name.trim().toLowerCase() === row.commonName.trim().toLowerCase()) {
                        commonUpdated = updateCommonName(row, speciesList[index]);
                    } else {
                        // try matching with scientific name and common name combination of
                        var match = speciesList.find(function (species) {
                            return species.commonName.name === row.commonName;
                        })

                        commonUpdated = updateCommonName(row, match);

                        if (!commonUpdated) {
                            var parsedName = parseName(row.commonName)
                            // try matching with scientific name
                            match = speciesList.find(function (species) {
                                return species.commonName.scientificName.trim().toLowerCase() === parsedName.scientificName.trim().toLowerCase();
                            });

                            if (match) {
                                commonUpdated = updateCommonName(row, match);
                            } else {
                                // try matching with common name
                                match = speciesList.find(function (species) {
                                    return species.commonName.commonName.trim().toLowerCase() === parsedName.commonName.trim().toLowerCase();
                                });

                                if (match) {
                                    commonUpdated = updateCommonName(row, match);
                                }
                            }
                        }
                    }

                    if (!commonUpdated) {
                        print("Failed to find a match for " + row.commonName + " " + output.activityId);
                    }

                    updated = updated || commonUpdated;
                }
            });

            if (updated) {
                var result = db.output.update({outputId: output.outputId}, {$set: {"data.taxaObservations": taxaObservations}});
                if (result.nModified === 1) {
                    countUpdated ++;
                } else {
                    print("Issue updating outputId " + output.activityId);
                    print(JSON.stringify(taxaObservations))
                    errorUpdated ++;
                }
            } else {
                print("Not updating outputId " + output.activityId);
            }
        }
    }
});
print("Total records found " + totalRecords);
print("Total successfully migrated " + countUpdated);
print("Total errors " + errorUpdated);
print("Total not updated" + (totalRecords - countUpdated - errorUpdated));

function updateCommonName(row, match) {
    if(match && row) {
        row.commonName = match.commonName;
        return true;
    }

    return false;
}

function parseName(name) {
    print(name);
    var matches = name.match(/([^\(]+) \(([^\)]+)\)/)
    if(matches && (matches.length == 3)) {
        return {scientificName: matches[2], commonName: matches[1]}
    } else {
        return {scientificName: name, commonName: name}
    }
}